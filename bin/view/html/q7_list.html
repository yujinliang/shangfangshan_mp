<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script type="text/javascript" src="../js/jquery-2.1.4.min.js"></script>
        <script type="text/javascript" src="../js/handlebars-v3.0.3.js"></script>
        <script type="text/javascript" src="../js/handlebars-jquery.js"></script>
        <script type="text/javascript" src="../js/jquery.mobile-1.4.5.min.js"></script>
        <link rel="stylesheet" href="../js/jquery.mobile-1.4.5.min.css" type="text/css" />
        <script type="text/javascript">
        var vHostDomain = "http://webapp.jinliangyu_weinxin_dev.tunnel.mobi";
        var vQ7Id = {id:""};
        //for click item and go to q7 detail page.
        $(document).on("click", "#list_q7_list_page li a", function (e) {
            e.preventDefault();
            vQ7Id.id = $(this).data("q7-id");
            $.mobile.changePage(this.href, {transition:"pop", role:"dialog"});
        });
        //for q7_detail_page load data.
        $(document).on("pagebeforecreate", "#q7_detail_page", function (e) {
            $.getJSON(vHostDomain + "/get_q7_detail?q7_id=" + vQ7Id.id, function (data) {
                $("#name_header_q7_detail_page").text(data.name);
                $("#desc_content_q7_detail_page").text(data.desc);
                $("#limit_content_q7_detail_page").text(data.q7limit);
                $("#q7plan_content_q7_detail_page").text(data.q7plan);
                $("#enroll_content_q7_detail_page").text(data.enrollway);
                $("#images_content_q7_detail_page").text(data.imagenames);
            });
        });
        /* for infinite scroll only */
        $(document).on("pagebeforecreate", "#q7_list_page", function (e, ui) {
            //launch ajax for getting json data.
            $.getJSON(vHostDomain + "/get_q7_list?&count=20&page=1", function (data) {
                var items = ''
                $.each(data, function (i, item) { 
                    items += "<li>" + "<a href=#q7_detail_page data-q7-id=" + item.id + ">" +item.name + "</a>" + "</li>"; 
                })
                $("#list_q7_list_page").append(items).listview("refresh");
            });
        });
        var currentPageNumber = 1;
        /* load more fucntion */
        function addMore(page) {
            $.mobile.loading("show", {
                text: "Loading More...",
                textVisible: true,
                theme: "b"
            });
            setTimeout(function () {
                $.mobile.loading("hide");
            }, 2000);
            //launch ajax for getting json data.
            $.getJSON(vHostDomain + "/get_q7_list?count=20&page=" + (currentPageNumber + 1), function (data) {
                var items = ''
                $.each(data, function (i, item) {
                    
                    items += "<li>" + "<a href=#q7_detail_page data-q7-id=" + item.id + ">" + item.name + "</a>" + "</li>";
                    
                })
                $("#list_q7_list_page", page).append(items).listview("refresh");
                $.mobile.loading("hide");
                currentPageNumber += 1;
            });
        }

        /* scroll event */
        $(document).on("scrollstop", function (e) {
            var activePage = $.mobile.pageContainer.pagecontainer("getActivePage"),
            screenHeight = $.mobile.getScreenHeight(),
            contentHeight = $(".ui-content", activePage).outerHeight(),
            header = $(".ui-header", activePage).outerHeight() - 1,
            scrolled = $(window).scrollTop(),
            footer = $(".ui-footer", activePage).outerHeight() - 1,
            scrollEnd = contentHeight - screenHeight + header + footer;
            if (activePage[0].id == "q7_list_page" && scrolled >= scrollEnd) {
                console.log("adding..." + activePage);
                addMore(activePage);
            }
        });
        </script>
        <title>地藏七分类</title>
    </head>
    <body>
        <div id="q7_list_page" data-role="page">
            <div data-role="content">
                <ul id="list_q7_list_page" data-role="listview" data-theme="a" data-inset=true>
                </ul>
            </div>
        </div>
        <div id="q7_detail_page" data-role="page">
            <div id="header_q7_detail_page" data-role="header">
                <h1 id="name_header_q7_detail_page"></h1>
            </div>
            <div id="content_q7_detail_page" data-role="content">
                <p id="desc_content_q7_detail_page">描述</p>
                <p id="limit_content_q7_detail_page">限制</p>
                <p id="q7plan_content_q7_detail_page">时间</p>
                <p id="enroll_content_q7_detail_page">报名</p>
                <p id="images_content_q7_detail_page">图片</p>
                <div id="q7_submit">
                </div>
                <div id="q7_close">
                    <a href="#" data-role="button" data-rel="back">关闭</a>
                </div>
            </div>
        </div>
    </body>
</html>